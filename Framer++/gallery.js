// Gallery data structure
const galleryData = {
    "Editing Transitions": [
      {
        id: "840f146595b1ca0fdad1e68516ba6e84",
        dir: "02.editing.transitions/long-3r2"
      },
      {
        id: "04b55a593123460e2bd408ae8732af51",
        dir: "02.editing.transitions/long-3r2"
      },
      {
        id: "60be3305a913b8e4e254eb8b373a2823",
        dir: "02.editing.transitions/long-3r2"
      },
      {
        id: "5ffec686b1259d464e3074e4841375f9",
        dir: "02.editing.transitions/long-1r1"
      },
      {
        id: "344576e76fc469ee12374039d69bdd49",
        dir: "02.editing.transitions/long-3r2"
      },
      {
        id: "b19c1d89cdcb5c3377ec9d4016478a6f",
        dir: "02.editing.transitions/long-3r2"
      },
      {
        id: "e2d570d2c38fa8b4ba583dc365f97f2a",
        dir: "02.editing.transitions/long-3r2"
      }
    ],
    "Cartoon Inbetweening": [
      {
        id: "29a4bffd1b1faf2753f44ef2f9f5126b",
        dir: "03.cartoon.inbetweening/long1-16r9"
      },
      {
        id: "2bae2ea120bd1caaad27c47d4b51f8f9",
        dir: "03.cartoon.inbetweening/long2-16r9"
      },
      {
        id: "449405e3aa81c5d6da73cb4ab55fdaf9",
        dir: "03.cartoon.inbetweening/long1-16r9"
      },
      {
        id: "730181e48f633275ee5b5e5f11476675",
        dir: "03.cartoon.inbetweening/long1-16r9"
      },
      {
        id: "b7edeb810f445b8e83fd96864a9f7b77",
        dir: "03.cartoon.inbetweening/long1-16r9"
      },
      {
        id: "d575c57164a111c23886d119625c9cc4",
        dir: "03.cartoon.inbetweening/long1-16r9"
      },
      {
        id: "6a7b3de9c08e755048ec9ef8ce43b58d",
        dir: "03.cartoon.inbetweening/long2-16r9"
      },
      {
        id: "9b79dd2756c5b2f40e12dff8b25b9f53",
        dir: "03.cartoon.inbetweening/long2-16r9"
      },
      {
        id: "a411e1e4c30fb481d96233f543304a0f",
        dir: "03.cartoon.inbetweening/long2-16r9"
      },
      {
        id: "fc41d7c82b33850f835b11c8212dd0ad",
        dir: "03.cartoon.inbetweening/long2-16r9"
      },
      {
        id: "662036cae4ed51a7a10fa63b7f124e31",
        dir: "03.cartoon.inbetweening/short2-16r9"
      }
    ],
    "Morphing": [
      {
        id: "fe1b8b0a5839d9657bc49ca2ae22128d",
        dir: "04.morphing/long-1r1"
      },
      {
        id: "34c420f27dec7c35c74b14fcb98f3a05",
        dir: "04.morphing/long-1r1"
      },
      {
        id: "53da08f0f1049a56fbe49680d8692db4",
        dir: "04.morphing/long-1r1"
      },
      {
        id: "65e7aec742950514a4e0025def133fd5",
        dir: "04.morphing/long-1r1"
      },
      {
        id: "b5ae9fb763a5e837432b93a50cab2f5c",
        dir: "04.morphing/long-1r1"
      },
      {
        id: "da539d8df7322d786619f251126eb9a3",
        dir: "04.morphing/long-1r1"
      },
      {
        id: "28ce67587af103ff585c005cf62420fe",
        dir: "04.morphing/long-1r1"
      }
    ],
    "Time Lapsing": [
      {
        id: "1cd4905993950f02cbddc6aafb76155d",
        dir: "05.time.lapsing/long-1r1"
      },
      {
        id: "272a9d7ca3fd4ec2c70bc306ecdacbb3",
        dir: "05.time.lapsing/long-1r1"
      },
      {
        id: "2c74f0304d7cd189004df9333ee752b5",
        dir: "05.time.lapsing/long-16r9"
      },
      {
        id: "3064ddd76b53b6fb89fe3fa8d73ffa85",
        dir: "05.time.lapsing/long-16r9"
      },
      {
        id: "411316932-d9272843-83d3-4b8d-82ea-365094f14bfb",
        dir: "05.time.lapsing/short-1r1"
      }
    ],
    "View Transitions": [
      {
        id: "5f8dafc33334888da37643251468260b",
        dir: "06.view.transitions/long-3r2"
      },
      {
        id: "a4f98d7c7e843c1db2ef273eced3166b",
        dir: "06.view.transitions/long-3r2"
      },
      {
        id: "a5cb074502c041e0848aeeef05198ab8",
        dir: "06.view.transitions/long-3r2"
      },
      {
        id: "90a50e09f711a478e05dc5dc3b28eca2",
        dir: "06.view.transitions/long-4r3"
      },
      {
        id: "279254f22298d7016e795ae681981ff7",
        dir: "06.view.transitions/long-4r3"
      },
      {
        id: "a20eedeaf889c3629bd98165662b2c66",
        dir: "06.view.transitions/long-4r3"
      },
      {
        id: "2a66331d5359511c0e0cf8e0cfb6ff19",
        dir: "06.view.transitions/long-1r1"
      },
      {
        id: "92eae074bd1b371efb5758b09840031c",
        dir: "06.view.transitions/long-1r1"
      }
    ],
    "Transitions in the Wild": [
      {
        id: "0010",
        dir: "07.transitions.in.the.wild/long-3r2",
        noHash: true
      },
      {
        id: "0009",
        dir: "07.transitions.in.the.wild/short-3r2",
        noHash: true
      },
      {
        id: "0011",
        dir: "07.transitions.in.the.wild/long-3r2",
        noHash: true
      },
      {
        id: "0033",
        dir: "07.transitions.in.the.wild/long-3r2",
        noHash: true
      },
      {
        id: "0024",
        dir: "07.transitions.in.the.wild/short-3r2",
        noHash: true
      },
    ],
    "Temporal Super-Resolution": [
      {
        id: "2b1b95633a94c0a35bf9f5a1a277e58d",
        dir: "01.temporal.super-resolution/short-1r1"
      },
      {
        id: "3efb25182f7481981cd453c952c873c6",
        dir: "01.temporal.super-resolution/short-1r1"
      },
      {
        id: "11dc24ac53300b70788041ad407a373b",
        dir: "01.temporal.super-resolution/short-1r1"
      },
      {
        id: "77597fe1f712ac30af2428a6705aa761",
        dir: "01.temporal.super-resolution/short-1r1"
      },
      {
        id: "a35352e61f0112dc5b997ca4e1cd298e",
        dir: "01.temporal.super-resolution/short-1r1"
      },
      {
        id: "dc03ac96e082fa0b0c23fd10f695870b",
        dir: "01.temporal.super-resolution/short-1r1"
      },
      {
        id: "f91180d26fec555b606c7e2daf3ce3ec",
        dir: "01.temporal.super-resolution/short-1r1"
      }
    ]
  };
  



  // // Function to create a result card
  // function createResultCard(item) {
  //   const startImgSrc = `./gallery/${item.dir}/${item.noHash ? item.id + '+start' : item.id + '+start'}.jpg`;
  //   const videoSrc = `./gallery/${item.dir}/${item.id}_compressed.mp4`;
  //   const endImgSrc = `./gallery/${item.dir}/${item.noHash ? item.id + '+end' : item.id + '+end'}.jpg`;
  
  //   return `
  //     <div class="gallery-subsection">
  //       <div class="result-images">
  //         <div class="start-frame">
  //           <img src="${startImgSrc}" alt="Start Frame">
  //           <div class="frame-label">Start Frame</div>
  //         </div>
  //         <div class="video-container">
  //           <video autoplay loop muted playsinline controls>
  //             <source src="${videoSrc}" type="video/mp4">
  //           </video>
  //         </div>
  //         <div class="end-frame">
  //           <img src="${endImgSrc}" alt="End Frame">
  //           <div class="frame-label">End Frame</div>
  //         </div>
  //       </div>
  //     </div>
  //   `;
  // }
  
  // // Function to create a gallery section
  // function createGallerySection(title, items) {
  //   return `
  //     <section class="gallery-section">
  //       <h3 class="gallery-title collapsible">${title} <span class="toggle-icon">+</span></h3>
  //       <div class="result-content">
  //         <div class="result-grid">
  //           ${items.map(item => createResultCard(item)).join('')}
  //         </div>
  //       </div>
  //     </section>
  //   `;
  // }
  
  // // Generate the entire gallery
  // document.addEventListener('DOMContentLoaded', function() {
  //   const galleryContainer = document.getElementById('dynamic-gallery');
    
  //   // Add toggle all button before adding gallery sections
  //   const toggleAllButton = document.createElement('div');
  //   toggleAllButton.className = 'toggle-all-container';
  //   toggleAllButton.innerHTML = `
  //     <button id="toggle-all-button" class="toggle-all-button">
  //       <span class="toggle-all-icon">−</span>
  //       <span class="toggle-all-text">Collapse All</span>
  //     </button>
  //   `;
  //   galleryContainer.appendChild(toggleAllButton);
    
  //   // Add gallery sections
  //   const galleryHTML = Object.entries(galleryData)
  //     .map(([title, items]) => createGallerySection(title, items))
  //     .join('');
    
  //   // Create a container for the gallery sections
  //   const sectionsContainer = document.createElement('div');
  //   sectionsContainer.className = 'gallery-sections-container';
  //   sectionsContainer.innerHTML = galleryHTML;
  //   galleryContainer.appendChild(sectionsContainer);
  
  //   // Initialize collapsible functionality
  //   const collapsibles = document.querySelectorAll('.gallery-title.collapsible');
  //   let allExpanded = true; // Track the current state
    
  //   // Open all sections by default
  //   collapsibles.forEach(collapsible => {
  //     const content = collapsible.parentElement.querySelector('.result-content');
  //     const icon = collapsible.querySelector('.toggle-icon');
  //     content.classList.add('active');
  //     collapsible.classList.add('active');
  //     icon.textContent = '−';
  
  //     collapsible.addEventListener('click', function(e) {
  //       e.preventDefault();
  //       this.classList.toggle('active');
  //       const content = this.parentElement.querySelector('.result-content');
  //       content.classList.toggle('active');
  //       const icon = this.querySelector('.toggle-icon');
  //       icon.textContent = content.classList.contains('active') ? '−' : '+';
        
  //       // Update expand/collapse all button state after individual toggle
  //       updateToggleAllButtonState();
  //     });
  //   });
    
  //   // Toggle All Button Functionality
  //   const toggleAllBtn = document.getElementById('toggle-all-button');
  //   const toggleAllIcon = toggleAllBtn.querySelector('.toggle-all-icon');
  //   const toggleAllText = toggleAllBtn.querySelector('.toggle-all-text');
    
  //   toggleAllBtn.addEventListener('click', function() {
  //     allExpanded = !allExpanded;
      
  //     collapsibles.forEach(collapsible => {
  //       const content = collapsible.parentElement.querySelector('.result-content');
  //       const icon = collapsible.querySelector('.toggle-icon');
        
  //       if (allExpanded) {
  //         content.classList.add('active');
  //         collapsible.classList.add('active');
  //         icon.textContent = '−';
  //       } else {
  //         content.classList.remove('active');
  //         collapsible.classList.remove('active');
  //         icon.textContent = '+';
  //       }
  //     });
      
  //     // Update toggle all button
  //     toggleAllIcon.textContent = allExpanded ? '−' : '+';
  //     toggleAllText.textContent = allExpanded ? 'Collapse All' : 'Expand All';
  //   });
    
  //   // Function to update the toggle all button state based on sections
  //   function updateToggleAllButtonState() {
  //     const activeCount = document.querySelectorAll('.gallery-title.collapsible.active').length;
  //     const totalCount = collapsibles.length;
      
  //     allExpanded = activeCount === totalCount;
  //     toggleAllIcon.textContent = allExpanded ? '−' : '+';
  //     toggleAllText.textContent = allExpanded ? 'Collapse All' : 'Expand All';
  //   }
  // }); 


// Function to create a result card (保持不变)
function createResultCard(item) {
  const startImgSrc = `./gallery/${item.dir}/${item.noHash ? item.id + '+start' : item.id + '+start'}.jpg`;
  const videoSrc = `./gallery/${item.dir}/${item.id}_compressed.mp4`;
  const endImgSrc = `./gallery/${item.dir}/${item.noHash ? item.id + '+end' : item.id + '+end'}.jpg`;

  return `
      <div class="gallery-subsection">
        <div class="result-images">
          <div class="start-frame">
            <img src="${startImgSrc}" alt="Start Frame">
            <div class="frame-label">Start Frame</div>
          </div>
          <div class="video-container">
            <video autoplay loop muted playsinline controls>
              <source src="${videoSrc}" type="video/mp4">
            </video>
          </div>
          <div class="end-frame">
            <img src="${endImgSrc}" alt="End Frame">
            <div class="frame-label">End Frame</div>
          </div>
        </div>
      </div>
    `;
}

// // 修改后的函数：创建带有“展示更多”逻辑的 Section
// function createGallerySection(title, items) {
//   const firstItemHTML = createResultCard(items[0]);
//   const remainingItemsHTML = items.slice(1).map(item => createResultCard(item)).join('');
  
//   // 如果超过1个，则添加“Show More”按钮和隐藏容器
//   const hasMore = items.length > 1;
//   const moreContent = hasMore ? `
//     <div class="more-items-wrapper" style="display: none;">
//       ${remainingItemsHTML}
//     </div>
//     <div class="show-more-container">
//       <button class="show-more-button">Show More</button>
//     </div>
//   ` : '';

//   return `
//     <section class="gallery-section">
//       <h3 class="gallery-title collapsible">${title} <span class="toggle-icon">+</span></h3>
//       <div class="result-content">
//         <div class="result-grid">
//           ${firstItemHTML}
//           ${moreContent}
//         </div>
//       </div>
//     </section>
//   `;
// }

// 修改后的函数：创建带有“展示 2 个，更多则折叠”逻辑的 Section
function createGallerySection(title, items) {
  // 提取前两个项目作为默认显示
  const initialItemsHTML = items.slice(0, 2).map(item => createResultCard(item)).join('');
  
  // 提取剩余的项目（从第 3 个开始）
  const remainingItemsHTML = items.slice(2).map(item => createResultCard(item)).join('');
  
  // 如果总数超过 2 个，则添加“Show More”按钮和隐藏容器
  const hasMore = items.length > 2;
  const moreContent = hasMore ? `
    <div class="more-items-wrapper" style="display: none;">
      ${remainingItemsHTML}
    </div>
    <div class="show-more-container">
      <button class="show-more-button">Show More (${items.length - 2}+)</button>
    </div>
  ` : '';

  return `
    <section class="gallery-section">
      <h3 class="gallery-title collapsible">${title} <span class="toggle-icon">+</span></h3>
      <div class="result-content">
        <div class="result-grid">
          ${initialItemsHTML}
          ${moreContent}
        </div>
      </div>
    </section>
  `;
}

// Generate the entire gallery
document.addEventListener('DOMContentLoaded', function() {
  const galleryContainer = document.getElementById('dynamic-gallery');
  
  // 1. 添加全局收起/展开按钮
  const toggleAllButton = document.createElement('div');
  toggleAllButton.className = 'toggle-all-container';
  toggleAllButton.innerHTML = `
    <button id="toggle-all-button" class="toggle-all-button">
      <span class="toggle-all-icon">−</span>
      <span class="toggle-all-text">Collapse All</span>
    </button>
  `;
  galleryContainer.appendChild(toggleAllButton);
  
  // 2. 渲染各个 Section
  const galleryHTML = Object.entries(galleryData)
    .map(([title, items]) => createGallerySection(title, items))
    .join('');
  
  const sectionsContainer = document.createElement('div');
  sectionsContainer.className = 'gallery-sections-container';
  sectionsContainer.innerHTML = galleryHTML;
  galleryContainer.appendChild(sectionsContainer);

  // 3. 初始化大标题折叠功能 (保持您的逻辑)
  const collapsibles = document.querySelectorAll('.gallery-title.collapsible');
  collapsibles.forEach(collapsible => {
    const content = collapsible.parentElement.querySelector('.result-content');
    const icon = collapsible.querySelector('.toggle-icon');
    content.classList.add('active'); // 默认大类是展开的
    collapsible.classList.add('active');
    icon.textContent = '−';

    collapsible.addEventListener('click', function(e) {
      e.preventDefault();
      this.classList.toggle('active');
      const content = this.parentElement.querySelector('.result-content');
      content.classList.toggle('active');
      const icon = this.querySelector('.toggle-icon');
      icon.textContent = content.classList.contains('active') ? '−' : '+';
      updateToggleAllButtonState();
    });
  });

  // // 4. 新增：初始化每个 Section 内的 "Show More" 逻辑
  // document.querySelectorAll('.show-more-button').forEach(button => {
  //   button.addEventListener('click', function() {
  //     // 找到该按钮上方的隐藏内容容器
  //     const grid = this.closest('.result-grid');
  //     const moreWrapper = grid.querySelector('.more-items-wrapper');
      
  //     // 显示内容：使用 display: contents 确保子元素直接参与 grid 布局
  //     moreWrapper.style.display = 'contents';
      
  //     // 隐藏“Show More”按钮容器
  //     this.parentElement.style.display = 'none';
  //   });
  // });

  // 初始化 "Show More" 逻辑的代码部分保持不变
  document.querySelectorAll('.show-more-button').forEach(button => {
    button.addEventListener('click', function() {
      const grid = this.closest('.result-grid');
      const moreWrapper = grid.querySelector('.more-items-wrapper');
      
      // 展开隐藏项并保持 Grid 布局
      moreWrapper.style.display = 'contents';
      
      // 隐藏按钮
      this.parentElement.style.display = 'none';
    });
  });

  // 5. 全局 Toggle All 逻辑 (保持并微调)
  const toggleAllBtn = document.getElementById('toggle-all-button');
  toggleAllBtn.addEventListener('click', function() {
    const isActive = toggleAllBtn.querySelector('.toggle-all-text').textContent === 'Collapse All';
    collapsibles.forEach(collapsible => {
      const content = collapsible.parentElement.querySelector('.result-content');
      const icon = collapsible.querySelector('.toggle-icon');
      if (isActive) {
        content.classList.remove('active');
        collapsible.classList.remove('active');
        icon.textContent = '+';
      } else {
        content.classList.add('active');
        collapsible.classList.add('active');
        icon.textContent = '−';
      }
    });
    updateToggleAllButtonState();
  });

  function updateToggleAllButtonState() {
    const activeCount = document.querySelectorAll('.gallery-title.collapsible.active').length;
    const totalCount = collapsibles.length;
    const isAllExpanded = activeCount === totalCount;
    toggleAllBtn.querySelector('.toggle-all-icon').textContent = isAllExpanded ? '−' : '+';
    toggleAllBtn.querySelector('.toggle-all-text').textContent = isAllExpanded ? 'Collapse All' : 'Expand All';
  }

});



  /**
 * Scrollspy 滚动高亮逻辑
 */
document.addEventListener('DOMContentLoaded', function () {
    const tocLinks = document.querySelectorAll('.toc-link');
    
    // 1. 找到所有需要监控的 Section 元素
    const sections = Array.from(tocLinks).map(link => {
        const id = link.getAttribute('href').replace('#', '');
        // 如果是 #top，我们监控页面顶部的 hero 部分
        if (id === 'top') return document.querySelector('.hero');
        return document.getElementById(id);
    }).filter(el => el !== null);

    // 2. 配置观察器：当元素进入视口上方 20% 区域时触发
    const options = {
        root: null,
        rootMargin: '-20% 0px -75% 0px', // 探测窗口在屏幕中上部
        threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const id = entry.target.getAttribute('id') || 'top';
                
                // 清除所有高亮，激活当前对应的 ID
                tocLinks.forEach(link => {
                    const href = link.getAttribute('href').replace('#', '');
                    if (href === id || (id === 'top' && href === 'top')) {
                        link.classList.add('is-active');
                    } else {
                        link.classList.remove('is-active');
                    }
                });
            }
        });
    }, options);

    // 3. 开始执行观察
    sections.forEach(section => observer.observe(section));
});